Widget.types.event_detail = {
	initialize: function() {
		var _this = this;
		this._element = Widget.parseHTML("{{includeTemplate=edit}}");
		this._element.find('div.hide_if_not_saved').hide();
		this.current_detail_id = null;

		this.preview_text = this._element.find('div.event_preview');
		this.review_text = this._element.find('div.event_review');

		this.no_images_upload_info = jQuery('<div/>').html("{{writeString=wns.event.no_images_and_upload_info}}").addClass('no_images_placeholder');
		this.uploader = Widget.create('file_upload');
		this.droppable_area = _this._element.find('.droppable_area');
		this.droppable_area.append(this.no_images_upload_info);

		this.droppable_area.sortable({
			update: function(document, ui) {
				var ids = _this.droppable_area.children().map(function() {
					return jQuery(this).data('document_id');
				}).get();
				if(_this.current_detail_id !== null) {
					// only reorder if detail has been saved, otherwise sort order is taken from dom at saving time
					_this.reorderDocuments(ids);
				}
			}
		});

		this.uploader.allow_drag_to(_this.droppable_area, null, function(target, file) {
			return { document_category_id: _this.settings.events_document_category_id, callback: _this.upload_success.bind(_this), error: _this.upload_error.bind(_this)};
		});
		this._element.find("input[name^='date_']").datepicker({
			dateFormat: 'dd.mm.yy'
		});
		this._element.find("select[name='event_type_id']").prepareWidget(function(event_type_input) {
			event_type_input.settings.initial_selection = _this.settings.initial_type_id;
		}, jQuery.noop);

		if(!this.school_class_is_predefined()) {
			this._element.find('div.service_elements').hide();
			this.school_class_dropdown = this._element.find("select[name='school_class_id']");
			this.school_class_dropdown.prepareWidget(function(widget) {
				widget.settings.initial_selection = _this.settings.predefined_school_class_id;
			}, function(widget) {
				if(_this.settings.predefined_school_class_id) {
					widget.val(_this.settings.predefined_school_class_id);
				}
			});
		} else {
			this._element.find('div.school_class_elements').hide();
		}

		// Instance
		Widget.callStatic('detail', 'create_for_instance', this);

		// Handlers
		this.handle('opened', function() {
			this.init_textareas();
		});
		this.handle('saving', function(event, data) {
			data.body_preview = _this.event_preview_editor.get_data();
			data.body_review = _this.event_review_editor.get_data();
			data.school_class_id = _this.current_school_class_id;
		}.bind(_this));
	},

	school_class_is_predefined: function() {
		return this.settings.predefined_school_class_id !== null;
	},

	fill_data: function() {
		this.detail_widget.disable();
		this.eventData(function(data) {
			this.current_detail_id = data.Id;
			this._element.find("input[name='title']").val(data.Title);
			this._element.find("textarea[name='teaser']").val(data.Teaser);
			this._element.find("input[name='date_start']").val(data.DateStart);
			this._element.find("input[name='date_end']").val(data.DateEnd);
			this._element.find("input[name='time_details']").val(data.TimeDetails);
			this._element.find("input[name='location_info']").val(data.LocationInfo);
			this._element.find("input[name='is_active']").attr('checked', data.IsActive);
			this._element.find("input[name='ignore_on_frontpage']").attr('checked', data.IgnoreOnFrontpage);

			if(!this.school_class_is_predefined()) {
				this.school_class_dropdown.ensureWidget(function(widget) {
					widget.val(data.SchoolClassId);
				});
			} else {
				this.current_school_class_id = data.SchoolClassId;
			}
			this._element.find("select[name='event_type_id']").val(data.EventTypeId);
			this._element.find(".updated_info").text(data.UpdatedInfo);
			this._element.find(".created_info").text(data.CreatedInfo);
			this._element.find(".detail_id").text(data.Id);
			this.detail_widget.set_title(this.detail_widget.settings.title = data.Title);
			this.preview_text.ensureWidget(function(widget) {
				widget.set_data(data.BodyPreview);
			});
			this.review_text.ensureWidget(function(widget) {
				widget.set_data(data.BodyReview);
			});
			this.update_documents();
			this._element.find('div.hide_if_not_saved').show();
			this.detail_widget.enable();
		});
	},

	update_documents: function() {
		var _this = this;
		this.droppable_area.empty();
		this.allDocuments(_this.settings.thumbnail_size, function(documents) {
			if(documents.length === 0) {
				_this.droppable_area.append(_this.no_images_upload_info);
			}
			jQuery.each(documents, function(i, document_data) {
				_this.insert_thumbnail(document_data);
			});
		});
	},

	insert_thumbnail: function(document_data, container) {
		var _this = this;
		var document_id = document_data.Id;
		var doc = jQuery('<div/>').addClass('ui-widget ui-widget-content ui-image-picker-image ui-placeholder');
		doc.css({width: ''+this.settings.thumbnail_size+'px', height: this.settings.thumbnail_size+13+'px'});
		doc.data('document_id', document_id);

		jQuery('<span/>').addClass('ui-icon ui-icon-trash').click(function(event) {
			var delete_message = AdminInterface.strings.get_string('wns.document.delete_warning', { document_name: document_data.Name});
			Widget.confirm("{{writeString=wns.delete_warning_title}}", delete_message, function(confirmed) {
				if(confirmed) {
					_this.deleteDocument( document_id, function(result) {
						jQuery(doc).remove();
						if(_this.droppable_area.find('div.ui-image-picker-image').length === 0) {
							_this.droppable_area.empty().append(_this.no_images_upload_info);
						}
					});
				}
			});
			return false;
		}).appendTo(doc);
		var document_object = Widget.parseHTML(document_data.Preview);
		doc.addClass('pointer').attr('title', '{{writeString=wns.edit_file.dblclick}}').dblclick(function() {
			Widget.create('document_detail', function(detail) {
				detail.settings.is_called_externally = true;
				detail.auto_open = true;
			}, function(detail) {
				detail.setDocumentId(document_id);
				detail.fill_data();
				detail.save_callback = function() {
					var new_document_data = _this.getSingleDocument(document_id, _this.settings.thumbnail_size);
					doc.empty().append(Widget.parseHTML(new_document_data.Preview));
				};
			});
		});
		doc.append(document_object);
		this.droppable_area.find('div.no_images_placeholder').remove();
		this.droppable_area.append(doc);
	},

	upload_success: function(document_id, options) {
		var _this = this;
		this.addEventDocument(document_id, function() {
			_this.insert_thumbnail(_this.getSingleDocument(document_id, _this.settings.thumbnail_size));
		});
	},

	upload_error: function(error) {
	},

	init_textareas: function() {
		var _this = this;
		if(!this.preview_text.didPrepareWidget()) {
			this.preview_text.attr('data-widget-session', this.settings.richtext_session).prepareWidget(function(rich_text_widget) {
				_this.event_preview_editor = rich_text_widget;
				jQuery.extend(rich_text_widget.settings, _this.settings.richtext_settings);
			}, jQuery.noop);
		}
		if(!this.review_text.didPrepareWidget()) {
			this.review_text.attr('data-widget-session', this.settings.richtext_session).prepareWidget(function(rich_text_widget) {
				_this.event_review_editor = rich_text_widget;
				jQuery.extend(rich_text_widget.settings, _this.settings.richtext_settings, {
					height: 350
				});
			}, jQuery.noop);
		}
	},

	settings: {
		detail_widget: {
			title: "{{writeString=wns.event.create}}",
			width: 720
		},
		thumbnail_size: 150,
		initial_type_id: 1,
		predefined_school_class_id: null
	}
};
